#!/bin/bash
set -e

PATH="$PATH:`pwd`/scripts"
export PATH

OutputFile="regression_test.result"
ErrorMargin="0.05"
OutputDir="regression_out"
CompareFile=""

while getopts "b:e:o:c:" opt; do
    case $opt in
    b)
        BaseRegressionFile=$OPTARG
        ;;
    e)
        if [[ $OPTARG =~ "^[0.9]*.[0.9]\+$" ]]; then
            ErrorMargin=$OPTARG
        else
            echo "Argument for provided option -e is not a decimal number between 0-1" >&2
            exit 1
        fi
        ;;
    o)
        OutputFile=$OPTARG
        ;;
    c)
        CompareFile=$OPTARG
        ;;
    \?) 
        echo "Invalid option: -$OPTARG" >&2
        exit 1
        ;;
    :)
        echo "Option -$OPTARG requires an argument" >&2
        exit 1
        ;;
    esac
done

if [ -z $CompareFile ] && [ ! -f $CompareFile ]; then
    printf "Regression file specified: %s does not exists\n" "$CompareFile"
    exit 1
fi

abs(){
    [ `echo "$1 < 0" | bc -l` -eq 1 ] && echo "-1 * $1" | bc || echo $1
}

if [ ! -d "$OutputDir" ]; then
    mkdir $OutputDir
fi

if [ -f $OutpuFile ]; then
    > "$OutputFile"
fi

# Note Jenkins already makes SANA
echo "Making SANA"
if ! make &> /dev/null; then
    echo "Make failed for SANA"
    exit 1
fi

Networks_nodes=""
for network in `ls ./networks | grep "^[A-Z][A-Z]"`;do
    Networks_nodes=$Networks_nodes${network}" ""`head ./networks/${network}/${network}.gw | sed -n 5p`""\n"
done
Biogrid_network=`echo -e $Networks_nodes | sort -k2 -n | awk '{print $1}'`
Networks_count=`echo $Biogrid_network | wc -w`

for i in $(seq 1 $Networks_count);do
    for j in $(seq $((i + 1)) $Networks_count); do
        Network1=`echo -e $Biogrid_network | awk '{print $'$i'}'`
        Network2=`echo -e $Biogrid_network | awk '{print $'$j'}'`
        echo "Running $Network1-$Network2" >&2
        echo "./sana -g1 $Network1 -g2 $Network2 -o '$OutputDir/$Network1-$Network2' &> '$OutputDir/$Network1-$Network2.progress'"
    done
done | parallel 8  # run in parallel on jenkins

Iterations=""
echo "Checking Iterations Speed" >> $OutputFile
printf "%-30s | %-20s\n" "Networks Pair" "Iterations Speed" >> $OutputFile
for i in $(seq 1 $Networks_count);do
    for j in $(seq $((i + 1)) $Networks_count); do
        Network1=`echo -e $Biogrid_network | awk '{print $'$i'}'`
        Network2=`echo -e $Biogrid_network | awk '{print $'$j'}'`
        progress="$OutputDir/$Network1-$Network2.progress"
        cIt=`grep -o "[0-9]*.[0-9]* iterations" ./$progress | awk '{print $1}'`
        Iterations="$Iterations $cIt"
        printf "%-30s | %-20s\n" "$Network1-$Network2" "$cIt" >> $OutputFile

    done
done

IterationsAvg=`echo $Iterations | tr " " "\n" | awk '{s+=$1}END{print s/NR}'`
IterationsAvg=`printf "%f" $IterationsAvg`
printf "Iterations Average: %s \n" "$IterationsAvg" >> $OutputFile

PrintTestScores()
{
    Scores=""
    printf "Checking %s score\n" $1 >> $OutputFile
    printf "%-30s | %-20s\n" "Networks Pair" "$1 score" >> $OutputFile
    for i in $(seq 1 $Networks_count);do
        for j in $(seq $((i + 1)) $Networks_count); do
            Network1=`echo -e $Biogrid_network | awk '{print $'$i'}'`
            Network2=`echo -e $Biogrid_network | awk '{print $'$j'}'`
            progress="$OutputDir/$Network1-$Network2.out"
            Score=`grep -o "^$1: 0.[0-9]\+$" ./$progress | awk '{print $2}'`
            Scores=$Scores" "$Score
            printf "%-30s | %-20s\n" "$Network1-$Network2" "$Score" >> $OutputFile
        done
    done

    ScoresAvg=`echo $Scores | tr " " "\n" | awk '{s+=$1}END{print s/NR}'`
    ScoresAvg=`printf "%f" $ScoresAvg`
    printf "$1 Score Average: %s\n" "$ScoresAvg" >> $OutputFile
}

SCORES="ec ics s3 lccs sec"
for score in `echo $SCORES | tr ' ' '\n' `; do
    PrintTestScores $score
done

if [ ! -z "$CompareFile" ]; then
    BaseAverages=`cat $OutputFile | grep "Average" | grep -o "[0-9]\+.[0-9]\+"`
    Names=`cat $OutputFile | grep "Average" | awk '{print $1}'`
    NewAverages=`cat $CompareFile | grep "Average" | grep -o "[0-9]\+.[0-9]\+"`
    for i in $(seq `echo $BaseAverages | wc -w`);do
        baseItem=`echo -e $BaseAverages | awk '{print $'$i'}'`
        newItem=`echo -e $NewAverages | awk '{print $'$i'}'`
        name=`echo -e $Names | awk '{print $'$i'}'`
        errorDif=`parse "($baseItem - $newItem)/$baseItem"`
        echo $name $errorDif
        errorDif=`parse "ABS($errorDif)"`
        if [[ `echo "$errorDif < $ErrorMargin" | bc -l` -eq 0 ]]; then
            REGRESSION_FAILED="true"
        fi
    done

    echo "Checking SANA Locking Mechanism" >> $OutputFile
    RANDOM=1
    for i in `seq 4`; do
        offset=`shuf -i 1-7 -n 1`
        max=`expr 8 - $offset`
        select=`shuf -i "1-$offset" -n 1`
        select2=`expr $offset + $select`
        Network1=`echo -e $Biogrid_network | awk '{print $'$select'}'`
        Network2=`echo -e $Biogrid_network | awk '{print $'$select2'}'`
        paste <(cat ./networks/$Network1/${Network1}.gw | grep "|{[0-9]\+}|" | grep -o "[0-9]\+" | shuf -n 50) <(cat ./networks/$Network2/${Network2}.gw | grep "|{[0-9]\+}|" | grep -o "[0-9]\+" | shuf -n 50) > $OutputDir/$Network1-$Network2.locking
        sana -g1 $Network1 -g2 $Network2 -lock $OutputDir/$Network1-$Network2.locking -o $OutputDir/$Network1-$Network2-locking-test &> /dev/null
        if [[ `grep -f "$OutputDir/$Network1-$Network2.locking" "$OutputDir/$Network1-$Network2-locking-test.out.align" | wc -l` -ne 50 ]]; then
            REGRESSION_FAILED=true
            echo "Locking mechanism regression testing failed on $Network1 and $Network2 on $OutputDir/$Network1-$Network2.locking file"
        fi
    done

    if [ "$REGRESSION_FAILED" = true ];then
        exit 1
    else
        exit 0
    fi
fi
